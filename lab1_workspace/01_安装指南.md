# PyTorch从源码编译安装指南

## 当前环境
- Python: 3.13.9
- CUDA: 12.4
- GCC: 11.4.0
- 系统: Linux 5.15.0-161-generic

## 重要提示
⚠️ **Python 3.13可能与当前PyTorch版本存在兼容性问题！**
建议使用Python 3.8-3.11版本以获得更好的兼容性。

## 安装步骤

### 1. 创建合适的conda环境（推荐）
```bash
# 创建新的conda环境，使用Python 3.10
conda create -n pytorch-cuda python=3.10
conda activate pytorch-cuda

# 验证Python版本
python --version  # 应该显示Python 3.10.x
```

### 2. 安装依赖
```bash
cd /home/honglianglu/hdd/CS4302-pytorch

# 安装编译依赖
conda install cmake ninja
pip install -r requirements.txt

# 安装其他必要的包
conda install numpy pyyaml mkl mkl-include setuptools cmake cffi typing_extensions
conda install -c pytorch magma-cuda124  # 对应CUDA 12.4
```

### 3. 设置编译选项
```bash
# 导出环境变量
export CMAKE_PREFIX_PATH=${CONDA_PREFIX:-"$(dirname $(which conda))/../"}
export USE_CUDA=1
export TORCH_CUDA_ARCH_LIST="7.5;8.0;8.6;9.0"  # 根据你的GPU架构调整
export MAX_JOBS=8  # 根据你的CPU核心数调整

# 可选：加速编译
export USE_CUDNN=1
export USE_NCCL=1
```

### 4. 开始编译
```bash
cd /home/honglianglu/hdd/CS4302-pytorch

# 清理之前的构建（如果有）
python setup.py clean

# 开始编译安装（这将需要很长时间，可能1-2小时）
python setup.py develop  # 使用develop模式，方便后续修改代码

# 或者使用install模式
# python setup.py install
```

### 5. 验证安装
```bash
python -c "import torch; print(torch.__version__); print(torch.cuda.is_available())"
python -c "import torch; print(torch.cuda.get_device_name(0))"
```

## 常见问题

### Q1: Python 3.13兼容性问题
**问题**: PyTorch可能不完全支持Python 3.13
**解决**: 使用Python 3.10或3.11
```bash
conda create -n pytorch-dev python=3.10
conda activate pytorch-dev
```

### Q2: GCC版本问题
**当前**: GCC 11.4.0
**要求**: CUDA 12.4支持GCC 11.x，应该没问题

### Q3: 编译时间过长
**解决**: 
- 使用`MAX_JOBS`限制并行编译数量，避免内存不足
- 只编译需要的部分：`export USE_DISTRIBUTED=0`禁用分布式训练

### Q4: 内存不足
**解决**: 
```bash
export MAX_JOBS=4  # 减少并行任务
```

### Q5: CUDA架构设置
检查你的GPU架构：
```bash
nvidia-smi --query-gpu=compute_cap --format=csv
```
然后设置对应的架构：
- Compute Capability 7.5: GTX 16xx, Tesla T4
- Compute Capability 8.0: A100
- Compute Capability 8.6: RTX 30xx
- Compute Capability 9.0: RTX 40xx

## 快速安装脚本

创建 `install_pytorch.sh`:
```bash
#!/bin/bash

# 激活conda环境
conda activate pytorch-dev || { echo "Please create conda environment first!"; exit 1; }

# 进入PyTorch目录
cd /home/honglianglu/hdd/CS4302-pytorch

# 设置环境变量
export CMAKE_PREFIX_PATH=${CONDA_PREFIX}
export USE_CUDA=1
export TORCH_CUDA_ARCH_LIST="7.5;8.0;8.6;9.0"
export MAX_JOBS=8
export USE_CUDNN=1
export USE_NCCL=1

# 更新子模块
git submodule sync
git submodule update --init --recursive

# 开始编译
echo "Starting PyTorch compilation..."
python setup.py develop

# 验证
echo "Verifying installation..."
python -c "import torch; print('PyTorch version:', torch.__version__); print('CUDA available:', torch.cuda.is_available())"

echo "Installation complete!"
```

## 使用develop模式的优势

使用`python setup.py develop`而不是`install`的好处：
1. **代码修改即时生效**：修改源码后不需要重新安装
2. **方便调试**：可以直接在源码中添加打印语句
3. **适合开发和实验**：正是这个大作业需要的模式

## 修改CUDA算子后的重新编译

当你修改了`.cu`或`.cpp`文件后：
```bash
cd /home/honglianglu/hdd/CS4302-pytorch

# 只重新编译ATen库（包含CUDA算子）
python setup.py build --cmake-only
python setup.py develop

# 或者清理后完全重新编译
python setup.py clean
python setup.py develop
```

## 建议的工作流程

1. **第一次**: 完整编译安装PyTorch（1-2小时）
2. **修改算子**: 在`aten/src/ATen/native/cuda/`中修改
3. **重新编译**: 只编译修改的部分（5-10分钟）
4. **测试验证**: 运行测试脚本
5. **性能对比**: 使用profiler对比优化效果

## 下一步

安装完成后，继续进行：
1. 选择神经网络模型（YOLOv5）
2. 使用Profiler分析CUDA kernel调用
3. 调研关键算子的实现
4. 开始优化工作










